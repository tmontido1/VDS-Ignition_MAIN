<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1">
  <POU Name="MAIN" Id="{1957c99f-7c6a-48c3-b96f-a44a4ae5f1ca}" SpecialFunc="None">
    <Declaration><![CDATA[PROGRAM MAIN
VAR
//-------------------- Program Initialization Variables ----------------------------//
	i : INT; //Initialization Counter
	CycleCount : INT := 0; // Cycle counter
	Initialized : BOOL := FALSE; // Flag for initialization
	CtrlStatus : INT; // Status output
//----------------------------------------------------------------------------------//


//--------------------------------- Struct Init ------------------------------------//
// Constant array of valve names
	stValves : ARRAY[1..GVL.valveCount] OF ST_Valves;
	stPumps : ARRAY[1..GVL.pumpCount] OF ST_Pumps;
	stPressureSensors : ARRAY[1..GVL.pressureSensorCount] OF ST_PressureSensor;
	stMassFlowSensors : ARRAY[1..GVL.massFlowSensorCount] OF ST_MassFlowSensor;
//----------------------------------------------------------------------------------//


//----------------------------INIT Function Blocks----------------------------------//
	systemCheck_Valves : FB_CheckValveInputs;
	valveCtrl : FB_valveCTRL;
	pumpCtrl : FB_PumpCTRL;
	varPulse : FB_PulseValve;   // Instance of the function block
	unitOp_OverPressure : FBUO_OverPressure;
	unitOp_OverPressureEX : FBUO_OverPressure_EX;
	pressureMonitor : FB_PressureMonitor;
	massFlowMonitor : FB_MassFlowMonitor;
	flowPathCheck_WFI : FB_FlowPathCheck;
	wfi_MassFlowAvg10 : FB_MovingAverage;
	wfi_MassFlowAvg30 : FB_MovingAverage;
	wfi_MassFlowAvg100 : FB_MovingAverage;
//----------------------------------------------------------------------------------//	
	
//---------------------------- General Variables -----------------------------------//
	outputDO1 : BOOL;           // Local output variable
    tPulseTime : TIME := T#1000MS; // Pulse duration
	//avg10WFI_MassFlowRate : REAL;
	avg30WFI_MassFlowRate : REAL;
	avg100WFI_MassFlowRate : REAL;
	
//---------------------INIT Control Variables---------------------------------------//
	hOP_ProcessState			: BOOL	:= TRUE;	// Overpressure process step active
	hOP_ValvesPositionSet	 	: BOOL 	:= TRUE;	// Position Valves
	hOP_PumpActive				: BOOL	:= FALSE;	// Turn on Pump
	hOP_PumpSpeed				: REAL 	:= 0;		// Pump Speed
//----------------------------------------------------------------------------------//

//---------------------INIT Control Variables---------------------------------------//
	hOPEX_ProcessState			: BOOL	:= FALSE;	// Overpressure process step active
	hOPEX_ValvesPositionSet	 	: BOOL 	:= FALSE;	// Position Valves
	hOPEX_PumpActive			: BOOL	:= FALSE;	// Turn on Pump
//----------------------------------------------------------------------------------//

//---------------------Flow Path Definitions---------------------------------------//
	wfiFlowPath_OP		: ARRAY[1..GVL.valveCount] OF INT := [2,5,0,0,0,0,0,0,0,0];
	wfiFlowPath_OPEX	: ARRAY[1..GVL.valveCount] OF INT := [2,4,7,8,9,10,0,0,0,0];
	wfiActiveFlowPath	: ARRAY[1..GVL.valveCount] OF INT;
//----------------------------------------------------------------------------------//


//----------------------------INIT Function Blocks----------------------------------//
	fbSyringeSetup : FBUO_OPPump_SyringeSetup;
	fbAcetonePrime : FBUO_OPPump_AcetonePrime;
	fbFlowFormation : FBUO_OPFlowFormation;
//----------------------------------------------------------------------------------//

///---------------------Organic Phase Setup ---------------------------------------//
OPActive					: BOOL	:= FALSE;
bStartSyringeSetup			: BOOL	:= FALSE;	// Start Syringe Setup Routine
bStartActenePriming			: BOOL	:= FALSE;	// Start Acetone Priming Routine
bStartFlowFormation			: BOOL	:= FALSE;	// Start/Stop Continuous Flow Formation
nAcetoneCycles				: INT	:= 2;
nAcetoneCycle				: INT;	
//----------------------------------------------------------------------------------//

// -----------------------MATLAB Variables for testing ----------------------------//
mtbIN		: INT		:= 1000;
mtbOUT		: INT;
mtbActive	: BOOL		:= FALSE;	
currentValue : REAL := 0;
END_VAR

]]></Declaration>
    <Implementation>
      <ST><![CDATA[//------------------------------------Process Code ----------------------------------------//
//---------------------------------- Initialization----------------------------------------//
IF NOT Initialized THEN
    FOR i := 1 TO gvl.valveCount DO
        stValves[i].Name := GVL.sValveNames[i]; // Assign valve names
		stValves[i].ID := GVL.stValveID[i];
        stValves[i].State := 0; // Initialize to Closed
        stValves[i].AO1 := 0.0; // Closed position
        stValves[i].Status := 0; // No faults
        stValves[i].isOpen := FALSE; // Initialize to closed
    END_FOR
	FOR i := 1 TO GVL.pumpCount DO
		stPumps[i].Name := WSTRING_TO_STRING(GVL.sPumpNames[i]);
		stPumps[i].ID := i;
		stPumps[i].IsOn := FALSE;
		stPumps[i].CMDVoltage := 0.0;
		stPumps[i].ControllerIsOn := FALSE;
		stPumps[i].DO1 := FALSE;
		stPumps[i].AO1 := 0.0;
		stPumps[i].PressureValue := 0.0;
		stPumps[i].PressureLimit := 10.0;
		stPumps[i].OverPressure := FALSE;
		stPumps[i].FlowPathOpen := FALSE;
		stPumps[i].Status := 0;
	END_FOR
	FOR i := 1 TO GVL.pressureSensorCount DO
		stPressureSensors[i].Name := WSTRING_TO_STRING(GVL.sPressureSensorNames[i]);
		stPressureSensors[i].ID := i;
		stPressureSensors[i].RawValue := 0.0;
		stPressureSensors[i].ScaledValue := 0.0;
		stPressureSensors[i].FilteredValue := 0.0;
		stPressureSensors[i].FilterTimeConst := 0.1;
		stPressureSensors[i].InputMin := 4.0;
		stPressureSensors[i].InputMax := 20.0;
		stPressureSensors[i].OutputMin := 0.0;
		stPressureSensors[i].OutputMax := 30.0;
		stPressureSensors[i].RangeError := FALSE;
		stPressureSensors[i].Status := 0;
	END_FOR
	FOR i := 1 TO GVL.massFlowSensorCount DO
		stMassFlowSensors[i].Name := WSTRING_TO_STRING(GVL.sMassFlowSensorNames[i]);
		stMassFlowSensors[i].ID := i;
		stMassFlowSensors[i].RawValue := 0.0;
		stMassFlowSensors[i].ScaledValue := 0.0;
		stMassFlowSensors[i].InputMin := 0;
		stMassFlowSensors[i].InputMax := 8388607.0;
		stMassFlowSensors[i].OutputMin := 0.0;
		stMassFlowSensors[i].OutputMax := 4500.0;
		stMassFlowSensors[i].RangeError := FALSE;
		stMassFlowSensors[i].Status := 0;
	END_FOR
    Initialized := TRUE;
END_IF
CycleCount := CycleCount + 1;

//--------------------------------------------------------------------------------------------//


//------------------------------ Valve Position Monitoring -----------------------------------//
systemCheck_Valves(
	fbCheckProcessState := TRUE, 
	fbValves 			:= stValves);
//--------------------------------------------------------------------------------------------//

//------------------------------- Flow Path Check --------------------------------------------//
// Select active flow path based on which operation is running
IF hOP_ProcessState THEN
	wfiActiveFlowPath := wfiFlowPath_OP;
ELSIF hOPEX_ProcessState THEN
	wfiActiveFlowPath := wfiFlowPath_OPEX;
END_IF
// Check if required valves are confirmed open
flowPathCheck_WFI(
	fbRequiredValves := wfiActiveFlowPath,
	fbValves := stValves);
stPumps[1].FlowPathOpen := flowPathCheck_WFI.fbPathOpen;
//------------------------------------------------------------------------------------------//

//------------------------- Overpressure Process (Development Only) --------------------------//
unitOp_OverPressureEX(
	fbOPprocessState 		:= hOPEX_ProcessState,
	fbValvePositionReady 	:= hOPEX_ValvesPositionSet, 
	fbValves 				:= stValves);
//--------------------------------------------------------------------------------------------//


//------------------------- Overpressure Process (Development Only) --------------------------//
unitOp_OverPressure(
	fbOPprocessState 		:= hOP_ProcessState,
	fbValvePositionReady 	:= hOP_ValvesPositionSet, 
	fbValves 				:= stValves,
	fbPumpActive			:=hOP_PumpActive,
	fbPumpSpeed				:= hOP_PumpSpeed);
//--------------------------------------------------------------------------------------------//

//---------------------------------- Atlas Syringe Setup--------------------------------------//
GVL_Serial.bEnablePCControl := OPActive;
IF OPActive THEN
  fbSyringeSetup(
      bEnable := TRUE,
      bStart  := bStartSyringeSetup
  );
//--------------------------------------------------------------------------------------------//  

//---------------------------------- Acetone Priming -----------------------------------------//
  fbAcetonePrime(
      bEnable            := TRUE,
      bStartAcetonePrime := bStartActenePriming,
      nSyringeCycles     := nAcetoneCycles
  );
  // Monitor progress
  nAcetoneCycle := fbAcetonePrime.nCurrentCycle;  // Shows 1, then 2

//---------------------------------- Continuous Flow Formation --------------------------------//
  fbFlowFormation(
      bEnable := TRUE,
      bStart  := bStartFlowFormation
  );
END_IF
//--------------------------------------------------------------------------------------------// 

//OP Routine Status
  IF fbSyringeSetup.bDone THEN
      // Syringes at 12.5ml - ready for operator to attach
  END_IF

  IF fbAcetonePrime.bDone THEN
      // Priming complete, syringes are empty
  END_IF

//------------------------------ Pressure Monitoring ----------------------------------------//
// Pressure Sensor I/O Mapping
stPressureSensors[1].RawValue := IO.AI_wfiPressureSensor;
// stPressureSensors[2].RawValue := IO.AI_suspPressureSensor;       // uncomment when wired
// stPressureSensors[3].RawValue := IO.AI_tffOutletPressureSensor;  // uncomment when wired
pressureMonitor(fbSensors := stPressureSensors);
//---------------------------------------------------------------------------------------------//

//----------------------------- Mass Flow Monitoring -----------------------------------------------------//					
// Mass Flow Sensor I/O Mapping (DINT to REAL conversion at boundary)
stMassFlowSensors[1].RawValue := DINT_TO_REAL(IO.AI_wfiFlowMeter);
// stMassFlowSensors[2].RawValue := DINT_TO_REAL(IO.AI_suspMassFlowMeter);     // uncomment when wired
// stMassFlowSensors[3].RawValue := DINT_TO_REAL(IO.AI_dischargeFlowMeter);    // uncomment when wired
massFlowMonitor(fbSensors := stMassFlowSensors);

// 10-sample moving average for WFI mass flow rate
wfi_MassFlowAvg10(
	fbInputValue := stMassFlowSensors[1].ScaledValue,
	fbSampleSize := 10,
	fbAverageValue => GVL.avg10WFI_MassFlowRate);

// 30-sample moving average for WFI mass flow rate
wfi_MassFlowAvg30(
	fbInputValue := stMassFlowSensors[1].ScaledValue,
	fbSampleSize := 30,
	fbAverageValue => avg30WFI_MassFlowRate);

// 100-sample moving average for WFI mass flow rate
wfi_MassFlowAvg100(
	fbInputValue := stMassFlowSensors[1].ScaledValue,
	fbSampleSize := 100,
	fbAverageValue => avg100WFI_MassFlowRate);
//-----------------------------------------------------------------------------------------------------//

//------------------------------- Pump Control ------------------------------------//
// Map filtered pressure readings to pumps for overpressure protection
stPumps[1].PressureValue := stPressureSensors[1].FilteredValue;	// WFI Pump <- WFI Pressure
stPumps[2].PressureValue := stPressureSensors[2].FilteredValue;	// Suspension Pump <- Suspension Pressure
pumpCtrl(fbPumps := stPumps);
// WFI Pump I/O Mapping (index 1)
IF mtbActive AND NOT stPumps[1].ControllerIsOn THEN
	IO.DO_wfiPump := stPumps[1].DO1;
	IO.AO_wfiPump := stPumps[1].AO1;
	ELSE
	IO.DO_wfiPump := FALSE;
	IO.AO_wfiPump := 0;
END_IF
// Suspension Pump I/O Mapping (index 2) - uncomment when I/O available
// IO.DO_suspPump := stPumps[2].DO1;
// IO.AO_suspPump := stPumps[2].AO1;
//--------------------------------------------------------------------------------------------------------------//

//------------------------------- Matlab Testing ---------------------------------------------------------------//

IF mtbActive AND mtbOut <500 THEN
	mtbOut := mtbOut+mtbIN;
	ELSE
	mtbOut :=0;
END_IF
IO.AO1_TestManifold := currentValue;
//--------------------------------------------------------------------------------------------------------------//

//------------------------------- Valve Init Function (To be refined later) ------------------------------------//
// Correct function block call with inputs
varPulse(Valve := outputDO1, pulseTime := tPulseTime);
// Assign output to global I/O
IO.DO1_dilutionSV := outputDO1;
//-----------------------------------------------------------------------------------------------------//

//-----------------------------Process Code END ----------------------------------------//
]]></ST>
    </Implementation>
  </POU>
</TcPlcObject>